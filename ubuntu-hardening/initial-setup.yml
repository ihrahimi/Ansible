---
- name: Phase 1 - Configure SSH Port and Admin User
  hosts: all
  become: true
  vars:
    current_ssh_port: 22           # Default SSH port (before change)
    new_ssh_port: 19200            # New SSH port
    temp_admin_user: "ansible_admin"  # New admin user
    temp_admin_ssh_key: "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIJGC4GVUTGKdIID2YF5aH6Ky0sJdxD1+m6U7mYkdjAoW"

  tasks:
    # Create admin user with sudo
    - name: Create admin user
      user:
        name: "{{ temp_admin_user }}"
        groups: sudo
        shell: /bin/bash
        state: present

    - name: Add SSH key for admin user
      ansible.posix.authorized_key:
        user: "{{ temp_admin_user }}"
        state: present
        key: "{{ temp_admin_ssh_key }}"

    # Configure new SSH port (temporarily keep old port during transition)
    - name: Backup sshd_config
      copy:
        src: /etc/ssh/sshd_config
        dest: /etc/ssh/sshd_config.bak
        remote_src: true

    - name: Set new SSH port
      lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^#?Port'
        line: "Port {{ new_ssh_port }}"
        state: present
      notify: restart sshd

    # Allow new port in firewall (if UFW is used)
    - name: Allow new SSH port in UFW
      ufw:
        rule: allow
        port: "{{ new_ssh_port }}"
        proto: tcp
      when: ansible_facts.services['ufw.service'] is defined

  handlers:
    - name: restart sshd
      service:
        name: ssh
        state: restarted
